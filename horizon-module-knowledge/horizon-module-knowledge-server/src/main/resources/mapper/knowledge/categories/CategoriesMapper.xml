<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.horizon.module.knowledge.dal.mapper.categories.CategoriesMapper">

    <!-- ================== 基础 CRUD ================== -->

    <!-- 插入 -->
    <insert id="insert"
            parameterType="org.horizon.module.knowledge.dal.dataobject.categories.CategoriesDO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO knowledge_categories (
        tenant_id, question, lang_id, display_flag, deleted,
        creator, create_time, updater, update_time
        ) VALUES (
        #{tenantId}, #{question}, #{langId}, #{displayFlag}, #{deleted},
        #{creator}, NOW(), #{updater}, NOW()
        )
    </insert>

    <!-- 批量插入：存在则忽略 -->
    <insert id="insertBatchIgnore" parameterType="list">
        INSERT INTO knowledge_categories (
        question, lang_id, display_flag, deleted,
        creator, create_time, updater, update_time
        ) VALUES
        <foreach collection="list" item="e" separator=",">
            (
            #{e.question},
            #{e.langId},
            #{e.displayFlag},
            COALESCE(#{e.deleted}, FALSE),
            #{e.creator}, NOW(),
            #{e.updater}, NOW()
            )
        </foreach>
        ON CONFLICT (lang_id, question) DO NOTHING
    </insert>

    <!-- 查询已存在的分类 -->
    <select id="selectIdsByKeys"
            resultType="org.horizon.module.knowledge.dal.dataobject.categories.CategoriesDO">
        SELECT id, question, lang_id
        FROM knowledge_categories
        WHERE lang_id = #{langId}
        AND question IN
        <foreach collection="names" item="n" open="(" separator="," close=")">
            #{n}
        </foreach>
    </select>

    <!-- 更新 -->
    <update id="updateById"
            parameterType="org.horizon.module.knowledge.dal.dataobject.categories.CategoriesDO">
        UPDATE knowledge_categories
        SET
        tenant_id    = #{tenantId},
        question     = #{question},
        lang_id      = #{langId},
        display_flag = #{displayFlag},
        deleted      = #{deleted},
        updater      = #{updater},
        update_time  = NOW()
        WHERE id = #{id}
    </update>

    <!-- 删除（单条） -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM knowledge_categories WHERE id = #{id}
    </delete>

    <!-- 删除（批量） -->
    <delete id="deleteByIds" parameterType="list">
        DELETE FROM knowledge_categories
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 查询（单条） -->
    <select id="selectById" parameterType="long"
            resultType="org.horizon.module.knowledge.dal.dataobject.categories.CategoriesDO">
        SELECT
        id, tenant_id, question, lang_id, display_flag, deleted,
        creator, create_time, updater, update_time
        FROM knowledge_categories
        WHERE id = #{id}
    </select>

    <!-- ================== 分页（列表 + 统计） ================== -->

    <!-- 列表 -->
    <select id="selectPageList"
            parameterType="org.horizon.module.knowledge.controller.admin.categories.vo.CategoriesPageReqVO"
            resultType="org.horizon.module.knowledge.dal.dataobject.categories.CategoriesDO">
        SELECT
        id, tenant_id, question, lang_id, display_flag, deleted,
        creator, create_time, updater, update_time
        FROM knowledge_categories
        <where>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="langId != null and langId != ''">
                AND lang_id = #{langId}
            </if>
            <if test="displayFlag != null and displayFlag != ''">
                AND display_flag = #{displayFlag}
            </if>
            <if test="deleted != null">
                AND deleted = #{deleted}
            </if>
            <if test="question != null and question != ''">
                AND question LIKE CONCAT('%', #{question}, '%')
            </if>
        </where>
        ORDER BY id DESC
        LIMIT #{pageSize} OFFSET #{(pageNo - 1) * pageSize}
    </select>

    <!-- 统计 -->
    <select id="selectPageCount"
            parameterType="org.horizon.module.knowledge.controller.admin.categories.vo.CategoriesPageReqVO"
            resultType="long">
        SELECT COUNT(*)
        FROM knowledge_categories
        <where>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="langId != null and langId != ''">
                AND lang_id = #{langId}
            </if>
            <if test="displayFlag != null and displayFlag != ''">
                AND display_flag = #{displayFlag}
            </if>
            <if test="deleted != null">
                AND deleted = #{deleted}
            </if>
            <if test="question != null and question != ''">
                AND question LIKE CONCAT('%', #{question}, '%')
            </if>
        </where>
    </select>

</mapper>