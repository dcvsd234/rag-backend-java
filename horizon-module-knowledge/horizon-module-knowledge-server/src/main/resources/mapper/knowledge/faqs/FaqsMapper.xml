<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.horizon.module.knowledge.dal.mapper.faqs.FaqsMapper">

    <!-- ====== 插入 ====== -->
    <insert id="insert" parameterType="org.horizon.module.knowledge.dal.dataobject.faqs.FaqsDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO knowledge_faqs (
        tenant_id, node_id, knowledge_doc_versions_id, source_type,
        question, answer, lang_id, display_flag,
        deleted, creator, create_time, updater, update_time
        ) VALUES (
        #{tenantId}, #{nodeId}, #{knowledgeDocVersionsId}, #{sourceType},
        #{question}, #{answer}, #{langId}, #{displayFlag},
        #{deleted}, #{creator}, NOW(), #{updater}, NOW()
        )
    </insert>

    <!-- ====== 批量插入 ====== -->
    <insert id="insertBatch"
            parameterType="list"
            useGeneratedKeys="true"
            keyProperty="list.id"
            keyColumn="id">
        INSERT INTO knowledge_faqs (
        tenant_id,
        node_id,
        knowledge_doc_versions_id,
        source_type,
        question,
        answer,
        lang_id,
        display_flag,
        deleted,
        creator,
        create_time,
        updater,
        update_time
        ) VALUES
        <foreach collection="list" item="e" separator=",">
            (
            #{e.tenantId},
            #{e.nodeId},
            #{e.knowledgeDocVersionsId},
            #{e.sourceType},
            #{e.question},
            #{e.answer},
            #{e.langId},
            #{e.displayFlag},
            COALESCE(#{e.deleted}, FALSE),
            #{e.creator}, NOW(),
            #{e.updater}, NOW()
            )
        </foreach>
        RETURNING id
    </insert>

    <!-- ====== 更新 ====== -->
    <update id="updateById" parameterType="org.horizon.module.knowledge.dal.dataobject.faqs.FaqsDO">
        UPDATE knowledge_faqs
        SET tenant_id = #{tenantId},
        node_id = #{nodeId},
        knowledge_doc_versions_id = #{knowledgeDocVersionsId},
        source_type = #{sourceType},
        question = #{question},
        answer = #{answer},
        lang_id = #{langId},
        display_flag = #{displayFlag},
        deleted = #{deleted},
        updater = #{updater},
        update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- ====== 删除 ====== -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM knowledge_faqs WHERE id = #{id}
    </delete>

    <delete id="deleteByIds" parameterType="list">
        DELETE FROM knowledge_faqs WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- ====== 查询 ====== -->
    <select id="selectById" parameterType="long" resultType="org.horizon.module.knowledge.dal.dataobject.faqs.FaqsDO">
        SELECT *
        FROM knowledge_faqs
        WHERE id = #{id}
    </select>

    <!-- ====== 分页查询列表 ====== -->
    <select id="selectPageList" parameterType="org.horizon.module.knowledge.controller.admin.faqs.vo.FaqsPageReqVO"
            resultType="org.horizon.module.knowledge.dal.dataobject.faqs.FaqsDO">
        SELECT *
        FROM knowledge_faqs
        <where>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="nodeId != null">
                AND node_id = #{nodeId}
            </if>
            <if test="knowledgeDocVersionsId != null">
                AND knowledge_doc_versions_id = #{knowledgeDocVersionsId}
            </if>
            <if test="question != null and question != ''">
                AND question ILIKE CONCAT('%', #{question}, '%')
            </if>
            <if test="displayFlag != null and displayFlag != ''">
                AND display_flag = #{displayFlag}
            </if>
            <if test="deleted != null">
                AND deleted = #{deleted}
            </if>
        </where>
        ORDER BY id DESC
        LIMIT #{pageSize} OFFSET #{(pageNo-1) * pageSize}
    </select>

    <!-- ====== 分页统计总数 ====== -->
    <select id="selectPageCount" parameterType="org.horizon.module.knowledge.controller.admin.faqs.vo.FaqsPageReqVO" resultType="long">
        SELECT COUNT(*)
        FROM knowledge_faqs
        <where>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="nodeId != null">
                AND node_id = #{nodeId}
            </if>
            <if test="knowledgeDocVersionsId != null">
                AND knowledge_doc_versions_id = #{knowledgeDocVersionsId}
            </if>
            <if test="question != null and question != ''">
                AND question ILIKE CONCAT('%', #{question}, '%')
            </if>
            <if test="displayFlag != null and displayFlag != ''">
                AND display_flag = #{displayFlag}
            </if>
            <if test="deleted != null">
                AND deleted = #{deleted}
            </if>
        </where>
    </select>

</mapper>